<project name="haxeServer" default="deploy-all">
	
	<property name="output.server.dir" value="output/server"/>
	<property name="output.admin.dir" value="output/admin"/>
	
	<taskdef name="svn" classname="org.tigris.subversion.svnant.SvnTask"/>
	<taskdef name="if" classname="ise.antelope.tasks.IfTask"/>
	
	<target name="svn-update">
		<if name="svn.update" value="true">
			<svn javahl="false" svnkit="true" username="canab.ua" password="gM9by4kJ5MB2">
				<update dir=".."/>
			</svn>
			<else>
				<echo>disabled</echo>
			</else>
		</if>
	</target>
	
	<target name="deploy-all" depends="build-all, deploy-server, deploy-admin"/>
	<target name="build-all" depends="build-server, build-admin"/>
	
	<target name="deploy-server" depends="build-server">
		<delete dir="${server.deploy.dir}"/>
		<mkdir dir="${server.deploy.dir}"/>
	 	<copy todir="${server.deploy.dir}">
	 		<fileset dir="${output.server.dir}"/>
	 	</copy>
	</target>
	
	<target name="deploy-admin" depends="build-admin">
		<delete dir="${admin.deploy.dir}"/>
		<mkdir dir="${admin.deploy.dir}"/>
	 	<copy todir="${admin.deploy.dir}">
	 		<fileset dir="${output.admin.dir}"/>
	 	</copy>
	</target>
	
	<target name="build-server" depends="svn-update">
		<delete dir="${output.server.dir}"/>
		<mkdir dir="${output.server.dir}"/>
		
	 	<copy file="../server/server-config.xml" todir="${output.server.dir}"/>
		<replace file="${output.server.dir}/server-config.xml" token="{host}" value="${server.config.host}"/>
		<replace file="${output.server.dir}/server-config.xml" token="{port}" value="${server.config.port}"/>
		<replace file="${output.server.dir}/server-config.xml" token="{login}" value="${server.config.login}"/>
		<replace file="${output.server.dir}/server-config.xml" token="{password}" value="${server.config.password}"/>
		
		<condition property="haxe.compiler.debug" value="-debug" else="">
			<istrue value="${server.build.debug}"/>
		</condition>
		
		<exec executable="${haxe.compiler}" failonerror="true">
			<arg line="-cp ../server/src"/>
			<arg line="-cp ../library"/>
			<arg line="-main NekoServer"/>
			<arg line="-neko ${output.server.dir}/server.n"/>
			<arg line="${haxe.compiler.debug}"/>
		</exec>
	</target>
	
	<target name="build-admin" depends="svn-update">
		<condition property="mxmlc.compiler.debug" value="-debug" else="">
			<istrue value="${admin.build.debug}"/>
		</condition>
		
		<delete dir="${output.admin.dir}"/>
		<mkdir dir="${output.admin.dir}"/>
	</target>
</project>